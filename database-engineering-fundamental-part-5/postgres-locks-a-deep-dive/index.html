<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Part 5: Database Engineering Fundamentals: Postgres Locks — A Deep Dive" /><meta name="author" content="Pravin Tripathi" /><meta property="og:locale" content="en" /><meta name="description" content="Postgres Locks — A Deep Dive" /><meta property="og:description" content="Postgres Locks — A Deep Dive" /><link rel="canonical" href="https://pravin.dev/database-engineering-fundamental-part-5/postgres-locks-a-deep-dive/" /><meta property="og:url" content="https://pravin.dev/database-engineering-fundamental-part-5/postgres-locks-a-deep-dive/" /><meta property="og:site_name" content="Pravin on Software" /><meta property="og:image" content="https://pravin.dev/header.png" /><meta property="og:image:height" content="900" /><meta property="og:image:width" content="1600" /><meta property="og:image:alt" content="Generated using Copilot" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-07-05T05:00:00+05:30" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://pravin.dev/header.png" /><meta name="twitter:image:alt" content="Generated using Copilot" /><meta property="twitter:title" content="Part 5: Database Engineering Fundamentals: Postgres Locks — A Deep Dive" /><meta name="twitter:site" content="@pravin_yo" /><meta name="twitter:creator" content="@pravin_yo" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Pravin Tripathi","url":"https://www.linkedin.com/in/pravin-r-tripathi"},"dateModified":"2025-03-22T16:02:56+05:30","datePublished":"2024-07-05T05:00:00+05:30","description":"Postgres Locks — A Deep Dive","headline":"Part 5: Database Engineering Fundamentals: Postgres Locks — A Deep Dive","image":{"width":1600,"height":900,"alt":"Generated using Copilot","url":"https://pravin.dev/header.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://pravin.dev/database-engineering-fundamental-part-5/postgres-locks-a-deep-dive/"},"url":"https://pravin.dev/database-engineering-fundamental-part-5/postgres-locks-a-deep-dive/"}</script><title>Part 5: Database Engineering Fundamentals: Postgres Locks — A Deep Dive | Pravin on Software</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Pravin on Software"><meta name="application-name" content="Pravin on Software"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Pravin on Software</a></div><div class="site-subtitle font-italic">My Learning and Experiments in Software Engineering</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/pravinyo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/pravin_yo" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['pravinyo12','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Part 5: Database Engineering Fundamentals: Postgres Locks — A Deep Dive</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Part 5: Database Engineering Fundamentals: Postgres Locks — A Deep Dive</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1720135800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 5, 2024 </em> </span> <span> Updated <em class="" data-ts="1742639576" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 22, 2025 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1600 900'%3E%3C/svg%3E" data-src="/assets/img/database-engineering-fundamental-part-5/header.png" class="preview-img bg" alt="Generated using Copilot" width="1600" height="900" data-proofer-ignore><figcaption class="pt-2 pb-2">Generated using Copilot</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/pravin-r-tripathi">Pravin Tripathi</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3579 words"> <em>19 min</em> read</span></div></div></div><div class="post-content"><h1 id="postgres-locks--a-deep-dive">Postgres Locks — A Deep Dive</h1><p><img data-src="https://miro.medium.com/v2/resize:fill:88:88/1*j-h09TiaKTgYsIvVAHPa4Q@2x.jpeg" alt="" data-proofer-ignore></p><p><a href="https://medium.com/@hnasr?source=post_page---byline--9fc158a5641c--------------------------------">Hussein Nasser</a></p><p><img data-src="/assets/img/database-engineering-fundamental-part-5/1_LxTYAGHFfSLRTyI4qO6TfA.png" alt="" data-proofer-ignore></p><p>A VACUUM full can block a select, we will learn how and why in this blog and much more</p><p>I used to think database locks are two types, shared and exclusive. Readers acquire many shared locks on a resource (row, object or table) but only one writer can acquire an exclusive lock. If a writer has an exclusive lock no one can acquire shared locks and as a result no one can read (but the writer). When I started to dig into Postgres this binary view of locking changed completely and I understand why.</p><p>You see, in Postgres there are five lock categories and over 12 individual lock types. To be honest knowing which command obtains which lock is less relevant than knowing which command can conflict which command. By conflict here I mean commands block each other and can’t run concurrently.</p><p>In this blog I explore all types and categories of locks and at the end I show you the <a href="https://postgres-locks.husseinnasser.com/">Postgres Lock Conflicts tool</a> I wrote that shows what commands conflict with each other because the list can get huge looking at a matrix.</p><p>All the information here are official Postgres <a href="https://www.postgresql.org/docs/current/explicit-locking.html">doc</a> , <a href="https://github.com/postgres/postgres">source code</a> and ad-hoc testing on the app.</p><h1 id="table-locks"><strong>Table Locks</strong></h1><p>If you ask me what a table lock three years ago I would say its a lock you obtain on a table so no one can do anything on that table while you hold that lock. No inserts, updates or deletes or any DDLs. But that is further from the truth in Postgres. There are eight types of table locks in Postgres and transactions can have multiple table locks on the same table. Some of those locks conflict, some don’t. Let us explore them one by one. You can view the table locks in mode column in pg_locks table.</p><h2 id="access-exclusive"><span class="mr-2"><strong>ACCESS EXCLUSIVE</strong></span><a href="#access-exclusive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://postgres-locks.husseinnasser.com/?pglock=AccessExclusiveLock">ACCESS EXCLUSIVE</a> (or <a href="https://postgres-locks.husseinnasser.com/?pglock=AccessExclusiveLock"><em>AccessExclusiveLock</em></a> in the code) is the most aggressive table lock. If a command obtains this lock type on a table nothing can be done to this table as this lock type conflicts with all other table locks. You can’t do DMLs so select, update or delete rows are blocked. You can’t do DDLs, alter a column, create an index and even system operation such as <a href="https://postgres-locks.husseinnasser.com/?pgcommand=VACUUM">VACUUM</a> cannot execute on the table. It is a complete block.</p><p>What operations and commands in Postgres obtain this lock? I went through the doc pages and found all commands that obtain this kind of lock. Here they are, when anything in this list run, you can’t do anything to this table.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN ACCESS EXCLUSIVE TABLE LOCK
DROP TABLE
TRUNCATE
REINDEX
CLUSTER
VACUUM FULL
REFRESH MATERIALIZED VIEW
ALTER INDEX SET TABLESPACE
ALTER INDEX ATTACH PARTITION
ALTER INDEX SET FILLFACTOR
ALTER TABLE ADD COLUMN
ALTER TABLE DROP COLUMN
ALTER TABLE SET DATA TYPE
ALTER TABLE SET/DROP DEFAULT
ALTER TABLE DROP EXPRESSION
ALTER TABLE SET SEQUENCE
ALTER TABLE SET STORAGE
ALTER TABLE SET COMPRESSION
ALTER TABLE ALTER CONSTRAINT
ALTER TABLE DROP CONSTRAINT
ALTER TABLE ENABLE/DISABLE RULE
ALTER TABLE ENABLE/DISABLE ROW LEVEL SECURITY
ALTER TABLE SET TABLESPACE
ALTER TABLE RESET STORAGE
ALTER TABLE INHERIT PARENT
ALTER TABLE RENAME
</pre></table></code></div></div><p>This means for example, if you run <a href="https://postgres-locks.husseinnasser.com/?pgcommand=VACUUM+FULL">VACUUM FULL</a> for instance on a table, you can’t select or update to this table.</p><blockquote><p>You might say why did you have to spell out different methods on Alter table, the reason because different Alter tables obtain different types of locks which makes some alters block certain operations while others might not.</p></blockquote><h2 id="access-share"><span class="mr-2"><strong>ACCESS SHARE</strong></span><a href="#access-share" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://postgres-locks.husseinnasser.com/?pglock=AccessShareLock">ACCESS SHARE</a> (or <a href="https://postgres-locks.husseinnasser.com/?pglock=AccessShareLock"><em>AccessShareLock</em></a>) is the lightest weight lock type. Only two commands that I’m aware of acquire this lock and those are <a href="https://postgres-locks.husseinnasser.com/?pgcommand=SELECT">SELECT</a> and <a href="https://postgres-locks.husseinnasser.com/?pgcommand=COPY+TO">COPY TO</a>. It is an indication that someone is reading the table, whether it is a single row, all the rows and yes even no rows if you do a query on a table that returned nothing, that lock is also acquired (I tested it).</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN ACCESS SHARE TABLE LOCK
SELECT
COPY TO
</pre></table></code></div></div><p>This lock type only conflicts with the <a href="https://postgres-locks.husseinnasser.com/?pglock=AccessExclusiveLock">ACCESS EXCLUSIVE</a> which makes it easy to understand, if run a transaction that does a select you can’t do a VACUUM FULL (normal VACUUM is fine). The reason is <a href="https://postgres-locks.husseinnasser.com/?pgcommand=VACUUM+FULL">VACUUM FULL</a> or any of the commands that acquire ACCESS EXCLUSIVE does sergical changes to the layout of the table which will break consistency when selects are running. For example VACUUM FULL actually changes tuple ids, purging tables and reshuffling data, we can’t be having people reading the table while this is happening. This is as opposed to normal VACUUM which really (almost) act like both update and deletes.</p><h2 id="exclusive"><span class="mr-2"><strong>EXCLUSIVE</strong></span><a href="#exclusive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <a href="https://postgres-locks.husseinnasser.com/?pglock=ExclusiveLock">EXCLUSIVE</a> (or <a href="https://postgres-locks.husseinnasser.com/?pglock=ExclusiveLock">ExclusiveLock</a>) is very similar to the ACCESS EXCLUSIVE except it doesn’t conflict with reads acquired by ACCESS SHARE. This means you can do selects while an EXCLUSIVE table lock is on the table.</p><p>The odd thing I only found one command (<a href="https://postgres-locks.husseinnasser.com/?pgcommand=REFRESH+MATERIALIZED+VIEW+CONCURRENTLY">REFRESH MATERIALIZED VIEW CONCURRENTLY</a>) that acquires this lock. If I had to guess, this lock type was added because people wanted a way to refresh their materialized views and select from the table at the same time. The Refresh materialized view acquires an <a href="https://postgres-locks.husseinnasser.com/?pglock=AccessExclusiveLock">ACCESS EXCLUSIVE</a> blocking selects, so Postgres added both a new lock type Exclusive which conflicts with everything except <a href="https://postgres-locks.husseinnasser.com/?pglock=AccessShareLock">ACCESS SHARE</a> and then made a new command to allow refreshing the view concurrently. I’m sure more methods will fit into this slot lock type.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN EXCLUSIVE lock
REFRESH MATERIALIZED VIEW CONCURRENTLY
</pre></table></code></div></div><p>So you if you refresh your materialized view concurrently your table can’t be edited but can be read.</p><h2 id="row-share"><span class="mr-2"><strong>ROW SHARE</strong></span><a href="#row-share" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Buckle up the names only get more confusing from here on. <a href="https://postgres-locks.husseinnasser.com/?pglock=RowShareLock">ROW SHARE</a> (or <a href="https://postgres-locks.husseinnasser.com/?pglock=RowShareLock">RowShareLock</a>) is similar to ACCESS SHARE but was designed for the SELECT FORs command family. That is probably why it has the name ROW in it. While <a href="https://postgres-locks.husseinnasser.com/?pgcommand=SELECT+FOR+UPDATE">SELECT FOR UPDATE</a>, <a href="https://postgres-locks.husseinnasser.com/?pgcommand=SELECT+FOR+SHARE">SELECT FOR SHARE</a> and others work on rows remember this is still a table lock. So these kind of commands actually acquire two types of locks row locks (will see later) and the ROW SHARE row locks.</p><p>This lock type conflicts with ACCESS EXCLUSIVE and the <a href="https://postgres-locks.husseinnasser.com/?pglock=ExclusiveLock">EXCLUSIVE</a> lock. Which means anything that is acquired by the ACCESS EXCLUSIVE + our refresh materialized view concurrently.</p><p>Here is a list of commands that acquire ROW SHARE.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN ROW SHARE table lock
SELECT FOR UPDATE
SELECT FOR NO KEY SHARE
SELECT FOR SHARE
SELECT FOR KEY SHARE
</pre></table></code></div></div><p>So while true you can do normal SELECTs while refreshing your materialized view concurrently, you can’t really do a <a href="https://postgres-locks.husseinnasser.com/?pgcommand=SELECT+FOR+SHARE">SELECT FOR SHARE</a> for instance.</p><h2 id="row-exclusive"><span class="mr-2"><strong>ROW EXCLUSIVE</strong></span><a href="#row-exclusive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <a href="https://postgres-locks.husseinnasser.com/?pglock=RowExclusiveLock">ROW EXCLUSIVE</a> (or <a href="https://postgres-locks.husseinnasser.com/?pglock=RowExclusiveLock">RowExclusiveLock</a>) is obtained by DMLs (<a href="https://postgres-locks.husseinnasser.com/?pgcommand=INSERT">Insert</a>, <a href="https://postgres-locks.husseinnasser.com/?pgcommand=UPDATE+%28KEYS%29">Update</a>, <a href="https://postgres-locks.husseinnasser.com/?pgcommand=DELETE">Delete</a>, <a href="https://postgres-locks.husseinnasser.com/?pgcommand=MERGE">Merge</a> and <a href="https://postgres-locks.husseinnasser.com/?pgcommand=COPY+FROM">Copy From</a>. If you care about write latency to your table watch out for operations that conflict with this lock. Thus the name ROW in the lock name because methods often operates on rows.</p><p>Gotta watch out again, you might you a update or a delete that end touching no rows, the ROW EXCLUSIVE lock is still acquired. So if you have long running transactions watch out for blocks.</p><p>The methods acquiring ROW EXCLUSIVE are as follows</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN ROW EXCLUSIVE table lock
UPDATE
DELETE
INSERT
MERGE
COPY FROM
</pre></table></code></div></div><h2 id="share-row-exclusive"><span class="mr-2"><strong>SHARE ROW EXCLUSIVE</strong></span><a href="#share-row-exclusive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://postgres-locks.husseinnasser.com/?pglock=ShareRowExclusiveLock">SHARE ROW EXCLUSIVE</a> (or <a href="https://postgres-locks.husseinnasser.com/?pglock=ShareRowExclusiveLock">ShareRowExclusiveLock</a>) is similar to <a href="https://postgres-locks.husseinnasser.com/?pglock=ExclusiveLock">EXCLUSIVE</a> but is relaxed so that ROW SHAREs don’t conflict, so you may do the SELECT FORs with this type of lock but you still can’t do any modifications through DMLs. So methods that obtain this type of locks want to allow reads even the SELECT FORs but block writes. In case you had the question why not just use EXCLUSIVE that is why. It is all about relaxing and minimizing blocks.</p><p>What is interesting about SHARE ROW EXCLUSIVE is it does conflict with it self which means only one operation of this lock type can run so for instance you can’t run two create triggers (which is a method that acquire SHARE ROW EXCLUSIVE) at the same time on the same table, my guess is one create trigger might modify rows in the table and the other create trigger might also change the table and we don’t want that.</p><blockquote><p>Again remember if a transaction obtains a SHARE ROW EXCLUSIVE it can still make modifications to rows, other transactions can’t.</p></blockquote><p>Here are the methods that obtain this type.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN SHARE ROW EXCLUSIVE table lock
CREATE TRIGGER
ALTER TABLE ADD FOREIGN KEY
ALTER TABLE ENABLE/DISABLE TRIGGER
</pre></table></code></div></div><h2 id="share"><span class="mr-2"><strong>SHARE</strong></span><a href="#share" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <a href="https://postgres-locks.husseinnasser.com/?pglock=ShareLock">SHARE</a> (ShareLock) is similar to the <a href="https://postgres-locks.husseinnasser.com/?pglock=ShareRowExclusiveLock">SHARE ROW EXCLUSIVE</a> in a sense it blocks concurrent modifications but it doesn’t conflict with itself. Only <a href="https://postgres-locks.husseinnasser.com/?pgcommand=CREATE+INDEX">CREATE INDEX</a> obtain this type of lock, which means while creating an index you can’t change the data (because the index is reading the table and building the b+tree) but technically nothing stopping 7 different transactions from running 7 CREATE INDEX on the same table, so if you are blocking writes to create indexes, you can technically create them all at the same time. Of course you can also use the CREATE INDEX Concurrently which allows concurrent modifications but that doesn’t run in a transaction.</p><p><img data-src="/assets/img/database-engineering-fundamental-part-5/1_8rtdhmbP9oNLonbM1npiCw.png" alt="" data-proofer-ignore></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN SHARE table lock
CREATE INDEX
</pre></table></code></div></div><h2 id="share-update-exclusive"><span class="mr-2"><strong>SHARE UPDATE EXCLUSIVE</strong></span><a href="#share-update-exclusive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <a href="https://postgres-locks.husseinnasser.com/?pglock=ShareUpdateExclusiveLock">SHARE UPDATE EXCLUSIVE</a> (or <a href="https://postgres-locks.husseinnasser.com/?pglock=ShareUpdateExclusiveLock">ShareUpdateExclusiveLock</a>) is designed for methods who want to allow concurrent writes and reads but prevent schema changes and VACUUM runs. Normal VACUUM for instance acquire this lock which is why you can run VACUUM and still do edit to your table otherwise it will be a disaster.</p><p><a href="https://postgres-locks.husseinnasser.com/?pgcommand=CREATE+INDEX+CONCURRENTLY">CREATE INDEX CONCURRENTLY</a> is another interesting one where you can create an index and allow writes. This lock conflict with itself so no two VACUUMs can run concurrently and no two CREATE INDEX CONCURRENTLY as well. This also explains why many forms of ALTER TABLE commands acquire this type of lock, you want to allow edits but no two alters at the same time.</p><p>Following are the commands that acquire SHARE UPDATE EXCLUSIVE.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN SHARE UPDATE EXCLUSIVE table lock
VACUUM
REINDEX CONCURRENTLY
CREATE STATISTICS
CREATE INDEX CONCURRENTLY
COMMENT ON
ANALYZE
ALTER TABLE VALIDATE CONSTRAINT
ALTER TABLE SET WITHOUT CLUSTER
ALTER TABLE SET TOAST
ALTER TABLE SET STATISTICS
ALTER TABLE SET N_DISTINCT
ALTER TABLE SET FILLFACTOR
ALTER TABLE SET AUTOVACUUUM
ALTER TABLE DETACH PARTITION
ALTER TABLE CLUSTER ON
ALTER TABLE ATTACH PARTITION (PARENT)
ALTER INDEX (RENAME)
</pre></table></code></div></div><h2 id="table-lock-matrix"><span class="mr-2"><strong>Table Lock Matrix</strong></span><a href="#table-lock-matrix" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This is the matrix from the <a href="https://www.postgresql.org/docs/15/explicit-locking.html">doc</a>, it helps us understand what locks conflicts with what.</p><div class="table-wrapper"><table><thead><tr><th> <th>ACCESS SHARE<th>ROW SHARE<th>ROW EXCL.<th>SHARE UPDATE EXCL.<th>SHARE<th>SHARE ROW EXCL.<th>EXCL.<th>ACCESS EXCL.<tbody><tr><td>ACCESS SHARE<td> <td> <td> <td> <td> <td> <td> <td>X<tr><td>ROW SHARE<td> <td> <td> <td> <td> <td> <td>X<td>X<tr><td>ROW EXCL.<td> <td> <td> <td> <td>X<td>X<td>X<td>X<tr><td>SHARE UPDATE EXCL.<td> <td> <td> <td>X<td>X<td>X<td>X<td>X<tr><td>SHARE<td> <td> <td>X<td>X<td> <td>X<td>X<td>X<tr><td>SHARE ROW EXCL.<td> <td> <td>X<td>X<td>X<td>X<td>X<td>X<tr><td>EXCL.<td> <td>X<td>X<td>X<td>X<td>X<td>X<td>X<tr><td>ACCESS EXCL.<td>X<td>X<td>X<td>X<td>X<td>X<td>X<td>X</table></div><p>To me however the methods and commands that acquire the locks are more important than the locks themselves. Which is why I wrote this <a href="https://postgres-locks.husseinnasser.com/?pglock=ShareRowExclusiveLock">tool</a> to dynamically show which method’s conflicts with what commands and what commands are allowed concurrently. You will see it referenced all over this blog.</p><blockquote><p>Table locks are in memory and can be retrieved from the pg_locks view. The memory requirements for table locks are low because they are coarser compared to row locks. Which we will discuss later.</p></blockquote><p>Here is an example from the <a href="https://postgres-locks.husseinnasser.com/">Postgres Lock Conflicts</a> tool on VACUUM.</p><p><img data-src="/assets/img/database-engineering-fundamental-part-5/1_ihD9J_6RMjXbDGs5nfxJ_Q.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/img/database-engineering-fundamental-part-5/1_yLTFavp48E3WPgEDCjcduQ.png" alt="" data-proofer-ignore></p><h1 id="row-locks"><strong>Row Locks</strong></h1><p>Now that we talked about table locks time to go one level deeper to row locks. Row locks are critical to detect changes to row objects so we prevent two transactions changing the same row which results in lost updates.</p><p>Worth noting that INSERTed tuples don’t require row locks in postgres because they are only visible to the transaction that creates them. One reason probably why Postgres doesn’t support read uncommitted isolation level.</p><p>The methods that lock rows are limited to <a href="https://postgres-locks.husseinnasser.com/?pgcommand=DELETE">DELETE</a>, <a href="https://postgres-locks.husseinnasser.com/?pgcommand=UPDATE+%28NO+KEYS%29">UPDATE (NO KEY)</a>, <a href="https://postgres-locks.husseinnasser.com/?pgcommand=UPDATE+%28KEYS%29">UPDATE (KEY)</a>, and all the SELECT FORs.</p><p>UPDATE (NO KEY) is an update to a column that doesn’t have a unique index while UPDATE (KEY) is an update to a column that does have a unique index. Those two acquire different locks that is why they are spelled out.</p><p>Here are four row locks in Postgres we discuss them here.</p><h2 id="for-update"><span class="mr-2"><strong>FOR UPDATE</strong></span><a href="#for-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://postgres-locks.husseinnasser.com/?pglock=FORUPDATE">FOR UPDATE</a> is the highest row lock, when a row is locked FOR UPDATE you cannot delete or update it or do a SELECT FOR UPDATE on it. However you can still read it through a normal SELECT, if you want your selects to be blocked if someone is touching a row you may use <a href="https://postgres-locks.husseinnasser.com/?pgcommand=SELECT+FOR+KEY+SHARE">SELECT FOR KEY SHARE</a> instead which conflicts.</p><p>The following commands acquire a FOR UPDATE row lock.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN FOR UPDATE row lock
DELETE
UPDATE (KEY) -- UPDATE TO A COLUMN WITH A UNIQUE INDEX
SELECT
</pre></table></code></div></div><h2 id="for-no-key-update"><span class="mr-2"><strong>FOR NO KEY UPDATE</strong></span><a href="#for-no-key-update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This <a href="https://postgres-locks.husseinnasser.com/?pglock=FORNOKEYUPDATE">lock</a> is acquired by UPDATES to columns without unique index, so it is weaker than FOR UPDATE as it allows SELECT FOR KEY SHARE.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN FOR NO KEY UPDATE ROW LOCK
UPDATE (NO KEY) -- UPDATE TO A COLUMN WITH NO INDEX OR REGULAR INDEX (NON-UNIQUE)
</pre></table></code></div></div><h2 id="for-share"><span class="mr-2"><strong>FOR SHARE</strong></span><a href="#for-share" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This is the true <a href="https://postgres-locks.husseinnasser.com/?pglock=FORSHARE">shared lock</a>, transactions can acquire multiple FOR SHARE locks on a row. When a row is FOR SHAREd no DML can modify it.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN FOR SHARE
SELECT FOR SHARE
</pre></table></code></div></div><h2 id="for-key-share"><span class="mr-2"><strong>FOR KEY SHARE</strong></span><a href="#for-key-share" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <a href="https://postgres-locks.husseinnasser.com/?pglock=FORKEYSHARE">weakest row lock</a>, behaves like FOR SHARE but allows updates to columns without unique indexes.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>--LIST OF POSTGRES COMMANDS THAT OBTAIN FOR SHARE
SELECT FOR KEY SHARE
</pre></table></code></div></div><h2 id="row-lock-matrix"><span class="mr-2"><strong>Row Lock Matrix</strong></span><a href="#row-lock-matrix" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This matrix shows the 4 row locks and how they conflict with each other. The tool I wrote gives more visibility to the commands that block each other.</p><div class="table-wrapper"><table><thead><tr><th> <th>FOR KEY SHARE<th>FOR SHARE<th>FOR NO KEY UPDATE<th>FOR UPDATE<tbody><tr><td>FOR KEY SHARE<td> <td> <td> <td>X<tr><td>FOR SHARE<td> <td> <td>X<td>X<tr><td>FOR NO KEY UPDATE<td> <td>X<td>X<td>X<tr><td>FOR UPDATE<td>X<td>X<td>X<td>X</table></div><p>Postgres table locks are in memory, row locks are stored in the tuple (xmax system field), which saves memory at a cost of potential disk writes. This isn’t so bad for deletes or updates because we are technically touching the row but select for updates for instance, those read operations can now cause pages to get dirty which will trigger the background writer to flush them to disk.</p><blockquote><p>Row locks are memory intensive in other databases, I work with SQL Server almost on daily basis and if row locks are enabled SQL Server can easily run out of memory and fail the transaction when row locks can’t be acquired. That is why I appreciate the brilliance of Postgres row-lock designs. Nothing is free though, disk writes.</p></blockquote><h1 id="page-locks"><strong>Page locks</strong></h1><p>A <a href="https://medium.com/@hnasr/database-pages-a-deep-dive-38cdb2c79eb5">postgres page</a> is 8KB and stores tuples for table and indexes. Because the page is an in memory data structure, it needs to be protected from concurrent process accesses. You see, <a href="https://medium.com/@hnasr/postgresql-process-architecture-f21e16459907">Postgres design is process</a> based which means when you connect to the database you get your own backend process, and those backend processes compete to access pages stored in shared buffer pool.</p><p>It is not so bad if multiple processes reading the same page, but it is a problem if we have two processes attempting to write to the same page. You want to serialize <a href="https://medium.com/@hnasr/threads-and-connections-in-backend-applications-a225eed3eddb">those accesses</a> so you don’t corrupt data. This is classic operating system concepts with mutex and semaphores.</p><h1 id="dead-locks"><strong>Dead Locks</strong></h1><p>Dead locks happen when two transactions each holding different locks attempting to access each other’s resources and end up in an indefinite wait. Postgres detects dead locks and kills one of the transaction to move on.</p><p>Here is an example (while unlikely it can happen)</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>Tx1
BEGIN;
-- ACQUIRES AccessSharelock (OK
SELECT * FROM TEST
                                    Tx2
                                    BEGIN;
                                    -- ACQUIRES AccessSharelock (OK)
                                    SELECT * FROM TEST;
                                    -- Attempts to acquire
                                    -- AccessExlusiveLock get blocked by tx1
                                    ALTER TABLE ADD COLUMN A TEXT;
--Attempts to acquire Access
--Exclusive blocks by tx2
--dead lock
TRUNCATE TABLE TEST;

---DEAD LOCK X_X
</pre></table></code></div></div><p>Another example with row locks</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>Tx1
BEGIN;
-- ACQUIRES ShareRowLock (OK)
SELECT * FROM TEST
WHERE ID = 1
FOR SHARE
                                    Tx2
                                     BEGIN;
                                    -- ACQUIRES ShareRowLock (OK)
                                    SELECT * FROM TEST
                                    WHERE ID = 1
                                    FOR SHARE

                                    --Attempts to update the row (X)
                                    --blocked by Tx1 share lock
                                    UPDATE TEST SET V = 1
                                    WHERE ID = 1;

--Attempts to delete the row
--Blocked by Tx2 share lock
DELETE FROM TEST
WHERE ID = 1;

---DEAD LOCK X_X
</pre></table></code></div></div><p>Another dead lock example from the doc.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre>Tx1
BEGIN;
-- ACQUIRES FOR UPDATE lock
-- ON row 11111 (OK)
UPDATE accounts
SET balance = balance + 100.00
WHERE acctnum = 11111;                  Tx2
                                        BEGIN;
                                        -- ACQUIRES FOR UPDATE lock (OK)
                                        -- ON row 22222 (OK)
                                        UPDATE accounts
                                        SET balance = balance + 100.00
                                        WHERE acctnum = 22222;

                                        -- Attempts to acquire FOR UPDATE
                                        -- ON row 11111, blocked by tx1 (X)
                                        UPDATE accounts
                                        SET balance = balance - 100.00
                                        WHERE acctnum = 11111;

--Attempts to acquire FOR UPDATE
--On row 22222, blocked by tx2 (X)
UPDATE accounts
SET balance = balance - 100.00
WHERE acctnum = 22222;

---DEAD LOCK X_X
</pre></table></code></div></div><h1 id="advisory-locks"><strong>Advisory Locks</strong></h1><p>Sometimes the application requirement makes the native MVCC locks insufficent. That is why most databases provide application-level locks that are controlled by the application to be held and released. While those locks still live in the database they are acquired and released by the application.</p><p>You might say why not just use FOR SHARE and FOR UPDATE to simulate that. The problem is you have to have a row to lock in those cases and you might be unnecessarily blocking other transactions from doing legitment modifications to that row. Advisory locks are obtained on integer values not rows or tables. Those numbers can come from columns of rows they don’t have to be.</p><p>Another reason why row locks don’t work is they are always tied to a transacation, if the transcation commits or rollsback the locks are gone and this is something your application might not want. Take for example a long — running operation in the app that does multiple database transactions, you want to prevent multiple users from running this long running operation concurrently. It is almost very hard to control that with just normal locks so what you can do is obtain a session level adversary lock when the operation starts so other users will attempt to also to obtain the same Advisory lock and get blocked.</p><p>There are two types of advisory locks, session and transcation. Session locks obtained with pg_advisory_lock () are kept for the length of the session (connection), while transaction advisory locks obtained with pg_advisory_xact_lock () are kept for the length of the current running transaction.</p><p>Here is an example.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>
-- Start Applicaiton Operation
-- Acquires a session lock
SELECT pg_advisory_lock(100);
--TxA1
BEGIN;
--DO WORK
COMMIT;

                                    -- Start Applicaiton Operation
                                    -- Attemps Acquires a session lock
                                    -- BLOCKS (X)
                                    SELECT pg_advisory_lock(100);

--TxA2
BEGIN;
--DO MORE WORK
COMMIT;
--Release session lock 100
SELECT pg_advisory_unlock(100);
-- End Applicaiton Operation
                                    -- TxB1, lock unblocks
                                    BEGIN;
                                    --DO MORE WORK
                                    COMMIT;
                                    -- TxB2

                                     BEGIN;
                                    --DO MORE WORK
                                    COMMIT;

                                    --Release session lock 100
                                    SELECT pg_advisory_unlock(100);

</pre></table></code></div></div><h1 id="weak-locks"><strong>Weak Locks</strong></h1><p>6/21/2023 — I added this additional paragraph to mention weak locks, something I recently learned in Postgres. Postgres has weak locks, those are table locks that rarely conflicts , acquired by DMLs, they are mainly AccessShareLock, RowShareLock, RowExclusiveLock.</p><p>Because they are common, and weak, Postgres manages them through a fast path a data structure in the process as oppose through the normal lock manager. But it can’t just use that data structure with no limit, it has a limit and that limit is 16 weak locks per backend process according to the constant <a href="https://github.com/postgres/postgres/blob/master/src/include/storage/proc.h#L85">FP_LOCK_SLOTS_PER_BACKEND</a> which can’t be changed unless you recompile postgres alas. If you don’t know backend process == connection in postgres. So if your data model is heavily normalized OR you are using partitioning and your queries are scanning multiple partitioning in a long transaction watch out not to exceed that. otherwise you hit the lock manager and contention is created.</p><p><img data-src="/assets/img/database-engineering-fundamental-part-5/1_i7LdtmJ2-HlRYSo16yxYKg.png" alt="" data-proofer-ignore></p><h1 id="summary"><strong>Summary</strong></h1><p>Understanding Postgres locking will give you an edge to making better application design choices and better luck at trouble-shooting lock waiting, dead-locks and general latency when executing queries. Advisory locks can also be used to build interesting use cases that don’t work with normal MVCC locks. Hope you enjoyed this post.</p><p>If you like this content, consider checking out my <a href="https://database.husseinnasser.com/">database course</a>.</p><p><a href="/assets/document/attachment/database-engineering-fundamental-part-5//PostgresLocksADeepDive-New.pdf">Postgres+Locks+—+A+Deep+Dive-New.pdf</a></p><p><a href="/database-engineering-fundamental-part-5/">Back to Parent Page</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/article/'>Article</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/softwareengineering/" class="post-tag no-text-decoration" >softwareengineering</a> <a href="/tags/backenddevelopment/" class="post-tag no-text-decoration" >backenddevelopment</a> <a href="/tags/database-engineering/" class="post-tag no-text-decoration" >database-engineering</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Part+5%3A+Database+Engineering+Fundamentals%3A+Postgres+Locks+%E2%80%94+A+Deep+Dive+-+Pravin+on+Software&url=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-5%2Fpostgres-locks-a-deep-dive%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Part+5%3A+Database+Engineering+Fundamentals%3A+Postgres+Locks+%E2%80%94+A+Deep+Dive+-+Pravin+on+Software&u=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-5%2Fpostgres-locks-a-deep-dive%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-5%2Fpostgres-locks-a-deep-dive%2F&text=Part+5%3A+Database+Engineering+Fundamentals%3A+Postgres+Locks+%E2%80%94+A+Deep+Dive+-+Pravin+on+Software" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-5%2Fpostgres-locks-a-deep-dive%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/database-engineering-fundamental-part-2/">Part 2: Database Engineering Fundamentals</a><li><a href="/posts/system-design-roadmap/">Comprehensive Roadmap for Low-Level and High-Level Design Interview Preparation</a><li><a href="/database-engineering-fundamental-part-5/write-amplification-problem-in-postgresql/">Part 5: Database Engineering Fundamentals: Write Amplification Problem in PostgreSQL</a><li><a href="/database-engineering-fundamental-part-1/">Part 1: Database Engineering Fundamentals</a><li><a href="/database-engineering-fundamental-part-1/database-page/">Part 1: Database Engineering Fundamentals: Database Page</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/backenddevelopment/">backenddevelopment</a> <a class="post-tag" href="/tags/softwareengineering/">softwareengineering</a> <a class="post-tag" href="/tags/database-engineering/">database-engineering</a> <a class="post-tag" href="/tags/design/">design</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/smells/">smells</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/nodejs/">nodejs</a> <a class="post-tag" href="/tags/softwaredevelopment/">softwaredevelopment</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/database-engineering-fundamental-part-5/write-amplification-problem-in-postgresql/"><div class="card-body"> <em class="small" data-ts="1720157400" data-df="ll" > Jul 5, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Part 5: Database Engineering Fundamentals: Write Amplification Problem in PostgreSQL</h3><div class="text-muted small"><p> Write Amplification Problem in PostgreSQL Write Amplification Problem in PostgreSQL The Write Amplification Problem (WAP) typically arises in systems using Solid State Drives (SSDs) or other stor...</p></div></div></a></div><div class="card"> <a href="/database-engineering-fundamental-part-1/"><div class="card-body"> <em class="small" data-ts="1719775800" data-df="ll" > Jul 1, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Part 1: Database Engineering Fundamentals</h3><div class="text-muted small"><p> Table of Contents ACID Properties Understanding Database Internals Row-Based vs Column-Based Databases Primary Key vs Secondary Key Database Indexing SQL Query Planner and Optimizer ...</p></div></div></a></div><div class="card"> <a href="/database-engineering-fundamental-part-1/database-page/"><div class="card-body"> <em class="small" data-ts="1719779400" data-df="ll" > Jul 1, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Part 1: Database Engineering Fundamentals: Database Page</h3><div class="text-muted small"><p> Databases Pages (Article) Database Pages — A deep dive Databases often use fixed-size pages to store data. Tables, collections, rows, columns, indexes, sequences, documents and more eventually en...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/database-engineering-fundamental-part-5/innodb-b-tree-latch-optimization-history/" class="btn btn-outline-primary" prompt="Older"><p>Part 5: Database Engineering Fundamentals: InnoDB B-tree Latch Optimization History</p></a> <a href="/database-engineering-fundamental-part-5/postgres-vs-msysql/" class="btn btn-outline-primary" prompt="Newer"><p>Part 5: Database Engineering Fundamentals: Postgres vs MySQL</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://pravin.dev/database-engineering-fundamental-part-5/postgres-locks-a-deep-dive/'; this.page.identifier = '/database-engineering-fundamental-part-5/postgres-locks-a-deep-dive/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://pravin-dev.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://www.linkedin.com/in/pravin-r-tripathi">Pravin Tripathi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/backenddevelopment/">backenddevelopment</a> <a class="post-tag" href="/tags/softwareengineering/">softwareengineering</a> <a class="post-tag" href="/tags/database-engineering/">database-engineering</a> <a class="post-tag" href="/tags/design/">design</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/smells/">smells</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/nodejs/">nodejs</a> <a class="post-tag" href="/tags/softwaredevelopment/">softwaredevelopment</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WP90FFJ6SJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WP90FFJ6SJ'); }); </script>
