<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Part 3: Database Engineering Fundamentals" /><meta name="author" content="Pravin Tripathi" /><meta property="og:locale" content="en" /><meta name="description" content="Concurrency Control" /><meta property="og:description" content="Concurrency Control" /><link rel="canonical" href="https://pravin.dev/database-engineering-fundamental-part-3/" /><meta property="og:url" content="https://pravin.dev/database-engineering-fundamental-part-3/" /><meta property="og:site_name" content="Pravin on Software" /><meta property="og:image" content="https://pravin.dev/header.png" /><meta property="og:image:height" content="900" /><meta property="og:image:width" content="1600" /><meta property="og:image:alt" content="Generated using Copilot" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-07-03T01:00:00+05:30" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://pravin.dev/header.png" /><meta name="twitter:image:alt" content="Generated using Copilot" /><meta property="twitter:title" content="Part 3: Database Engineering Fundamentals" /><meta name="twitter:site" content="@pravin_yo" /><meta name="twitter:creator" content="@pravin_yo" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Pravin Tripathi","url":"https://www.linkedin.com/in/pravin-r-tripathi"},"dateModified":"2025-03-22T16:02:56+05:30","datePublished":"2024-07-03T01:00:00+05:30","description":"Concurrency Control","headline":"Part 3: Database Engineering Fundamentals","image":{"width":1600,"height":900,"alt":"Generated using Copilot","url":"https://pravin.dev/header.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://pravin.dev/database-engineering-fundamental-part-3/"},"url":"https://pravin.dev/database-engineering-fundamental-part-3/"}</script><title>Part 3: Database Engineering Fundamentals | Pravin on Software</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Pravin on Software"><meta name="application-name" content="Pravin on Software"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Pravin on Software</a></div><div class="site-subtitle font-italic">My Learning and Experiments in Software Engineering</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/pravinyo" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/pravin_yo" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['pravinyo12','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Part 3: Database Engineering Fundamentals</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Part 3: Database Engineering Fundamentals</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1719948600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 3, 2024 </em> </span> <span> Updated <em class="" data-ts="1742639576" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 22, 2025 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1600 900'%3E%3C/svg%3E" data-src="/assets/img/database-engineering-fundamental-part-3/header.png" class="preview-img bg" alt="Generated using Copilot" width="1600" height="900" data-proofer-ignore><figcaption class="pt-2 pb-2">Generated using Copilot</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/pravin-r-tripathi">Pravin Tripathi</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2394 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><h2 id="concurrency-control"><span class="mr-2">Concurrency Control</span><a href="#concurrency-control" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="exclusive-lock-vs-shared-lock"><span class="mr-2">Exclusive Lock vs Shared Lock</span><a href="#exclusive-lock-vs-shared-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Exclusive locks and shared locks are mechanisms used in database systems to manage concurrent access to data. Let’s explain these concepts with a graphical example:</p><pre><code class="language-mermaid">graph TD
    A[Database Resource]
    B[Transaction 1]
    C[Transaction 2]
    D[Transaction 3]

    subgraph "Exclusive Lock"
        A --&gt;|Locks| B
        C -.-x A
        D -.-x A
    end

    subgraph "Shared Lock"
        E[Database Resource]
        F[Transaction 4]
        G[Transaction 5]
        H[Transaction 6]
        E --&gt;|Locks| F
        E --&gt;|Locks| G
        E --&gt;|Locks| H
    end

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#ccf,stroke:#333,stroke-width:2px
</code></pre><h4 id="explanation"><span class="mr-2">Explanation:</span><a href="#explanation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><h5 id="exclusive-lock-x-lock"><span class="mr-2">Exclusive Lock (X-Lock)</span><a href="#exclusive-lock-x-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>Only one transaction can hold an exclusive lock on a resource at a time<li>Prevents other transactions from reading or writing to the locked resource<li>Used for write operations to ensure data consistency<li>In the diagram, Transaction 1 has an exclusive lock, blocking Transactions 2 and 3</ul><h5 id="shared-lock-s-lock"><span class="mr-2">Shared Lock (S-Lock)</span><a href="#shared-lock-s-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><ul><li>Multiple transactions can hold shared locks on the same resource simultaneously<li>Allows concurrent read access but prevents write access<li>Used for read operations to improve concurrency<li>In the diagram, Transactions 4, 5, and 6 all have shared locks on the same resource</ul><p>This visual representation illustrates how exclusive locks provide strict isolation for write operations, while shared locks allow concurrent read access, enhancing overall system performance in scenarios where multiple transactions need to read the same data simultaneously.</p><hr /><h3 id="dead-lock"><span class="mr-2">Dead Lock</span><a href="#dead-lock" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><img data-src="/assets/img/database-engineering-fundamental-part-3/image.png" alt="/assets/img/database-engineering-fundamental-part-3/image.png" data-proofer-ignore></p><p>In this case, the one who enters in dead lock first will get chance to execute the query and others will be aborted.</p><p>If the second transaction only had executed the first command and skipped the second command that would put it in a dead lock situation and made commit, then the first transaction will fail with duplicate key violation exception as the second insert is already committed in the table and due to primary key constraint it cannot add.</p><h4 id="question"><span class="mr-2">Question:</span><a href="#question" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">Deadlock</span> <span class="k">when</span> <span class="n">inserting</span> <span class="mi">20</span>

<span class="k">In</span> <span class="n">the</span> <span class="n">deadlock</span> <span class="n">video</span><span class="p">,</span> <span class="n">you</span> <span class="k">are</span> <span class="n">trying</span> <span class="k">to</span> <span class="k">insert</span> <span class="mi">20</span><span class="p">,</span> <span class="n">which</span> <span class="n">means</span> <span class="mi">20</span> <span class="n">doesn</span><span class="s1">'t 
exist in the table yet. So when transaction A inserts 20 but doesn'</span><span class="n">t</span> <span class="k">commit</span> <span class="n">it</span><span class="p">,</span>
<span class="n">why</span> <span class="k">is</span> <span class="n">transaction</span> <span class="n">B</span> <span class="n">getting</span> <span class="n">a</span> <span class="k">lock</span> <span class="n">issue</span> <span class="k">when</span> <span class="n">it</span> <span class="n">tries</span> <span class="k">to</span> <span class="n">also</span> <span class="k">insert</span> <span class="n">it</span><span class="o">?</span> 
<span class="n">Because</span> <span class="k">both</span> <span class="n">transactions</span> <span class="n">should</span> <span class="n">be</span> <span class="n">isolated</span> <span class="k">right</span><span class="o">?</span> <span class="k">For</span> <span class="n">B</span><span class="p">,</span> <span class="mi">20</span> <span class="n">doesn</span><span class="s1">'t exist yet,
so the question of lock or no lock should not even arise right?

Or this is a scenario where its not 100% isolation and transactions can read each other metadata?
</span></pre></table></code></div></div><h4 id="answer"><span class="mr-2">Answer:</span><a href="#answer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">This</span> <span class="n">happens</span> <span class="k">in</span> <span class="k">all</span> <span class="k">isolation</span> <span class="n">levels</span><span class="p">.,</span> <span class="k">both</span> <span class="n">transactions</span> <span class="k">are</span> <span class="n">racing</span> <span class="k">to</span> <span class="n">acquire</span>
<span class="n">a</span> <span class="k">key</span> <span class="k">lock</span> <span class="k">on</span> <span class="n">the</span> <span class="k">unique</span> <span class="k">primary</span> <span class="k">key</span><span class="p">.</span> <span class="n">Since</span> <span class="n">tx1</span> <span class="n">wrote</span> <span class="mi">20</span> <span class="n">it</span> <span class="n">acquires</span> <span class="n">a</span> <span class="k">lock</span> <span class="k">on</span> 
<span class="n">that</span> <span class="n">value</span><span class="p">,</span> <span class="n">so</span> <span class="k">no</span> <span class="n">other</span> <span class="n">transactions</span> <span class="n">attempt</span> <span class="k">to</span> <span class="k">write</span> <span class="n">a</span> <span class="k">similar</span> <span class="n">value</span> <span class="k">to</span> 
<span class="n">guarantee</span> <span class="n">uniqueness</span><span class="p">.</span> <span class="n">Tx2</span> <span class="n">attempting</span> <span class="k">to</span> <span class="k">write</span> <span class="mi">20</span> <span class="n">will</span> <span class="n">be</span> <span class="n">blocked</span> <span class="k">by</span> <span class="n">the</span> <span class="k">lock</span> <span class="k">from</span>
<span class="n">tx2</span><span class="p">.</span>

<span class="n">The</span> <span class="n">dead</span> <span class="k">lock</span> <span class="n">happens</span> <span class="k">when</span> <span class="n">we</span> <span class="k">do</span> <span class="n">the</span> <span class="k">following</span>

<span class="n">Tx1</span> <span class="k">and</span> <span class="n">Tx2</span> <span class="k">begin</span>
<span class="n">Tx1</span> <span class="n">writes</span> <span class="mi">20</span> <span class="p">(</span><span class="n">succeeds</span> <span class="k">and</span> <span class="n">locks</span> <span class="n">the</span> <span class="k">row</span> <span class="n">value</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">Tx2</span> <span class="n">writes</span> <span class="mi">30</span> <span class="p">(</span><span class="n">succeeds</span> <span class="k">and</span> <span class="n">locks</span> <span class="n">the</span> <span class="k">row</span> <span class="k">with</span> <span class="n">value</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">Tx1</span> <span class="n">writes</span> <span class="mi">30</span> <span class="p">(</span><span class="n">blocks</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">tx2</span> <span class="k">to</span> <span class="n">either</span> <span class="k">commit</span> <span class="k">or</span> <span class="k">rollback</span> <span class="k">to</span> 
<span class="n">release</span> <span class="n">the</span> <span class="k">lock</span> <span class="k">on</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">Tx2</span> <span class="n">writes</span> <span class="mi">20</span> <span class="p">(</span><span class="n">blocks</span> <span class="n">waiting</span> <span class="k">for</span> <span class="n">tx1</span> <span class="k">to</span> <span class="n">either</span> <span class="k">commit</span> <span class="k">or</span> <span class="k">rollback</span> <span class="k">to</span> 
<span class="n">release</span> <span class="n">the</span> <span class="k">lock</span> <span class="k">on</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">Dead</span> <span class="k">lock</span> <span class="k">as</span> <span class="k">both</span> <span class="n">transactions</span> <span class="k">are</span> <span class="n">waiting</span> <span class="k">on</span> <span class="k">each</span> <span class="n">other</span>
</pre></table></code></div></div><h4 id="follow-up-question"><span class="mr-2">Follow-up Question:</span><a href="#follow-up-question" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">but</span> <span class="n">why</span> <span class="n">would</span> <span class="n">Tx1</span> <span class="k">and</span> <span class="n">Tx2</span> <span class="n">wait</span> <span class="k">on</span> <span class="k">each</span> <span class="n">other</span><span class="p">.</span> <span class="k">For</span> <span class="n">example</span><span class="p">,</span> <span class="n">Tx1</span> <span class="n">writes</span> <span class="mi">20</span><span class="p">,</span> 
<span class="n">but</span> <span class="n">the</span> <span class="n">value</span> <span class="n">has</span> <span class="k">not</span> <span class="n">been</span> <span class="k">committed</span> <span class="k">to</span> <span class="k">table</span> <span class="k">right</span><span class="o">?</span> <span class="n">So</span> <span class="n">how</span> <span class="n">can</span> <span class="n">you</span> <span class="n">acquire</span> <span class="n">a</span>
<span class="k">lock</span> <span class="k">for</span> <span class="n">a</span> <span class="k">row</span> <span class="n">that</span> <span class="n">doesn</span><span class="s1">'t exist yet in the table? The row only exists if
commit has happened isn'</span><span class="n">t</span> <span class="n">it</span><span class="o">?</span>
</pre></table></code></div></div><h4 id="follow-up-answer"><span class="mr-2">Follow-up Answer:</span><a href="#follow-up-answer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">Fantastic</span> <span class="n">question</span><span class="o">!</span> <span class="n">The</span> <span class="k">row</span> <span class="k">is</span> <span class="k">not</span> <span class="k">committed</span> <span class="n">yet</span> <span class="k">to</span> <span class="n">disk</span> <span class="n">because</span> <span class="n">we</span> <span class="n">did</span> 
<span class="k">not</span> <span class="k">commit</span> <span class="n">but</span> <span class="n">it</span> <span class="k">is</span> <span class="n">available</span> <span class="k">in</span> <span class="n">memory</span> <span class="p">(</span><span class="n">dirty</span> <span class="n">page</span><span class="p">)</span> <span class="n">so</span> <span class="n">postgres</span> <span class="n">checks</span> 
<span class="n">its</span> <span class="n">memory</span> <span class="k">for</span> <span class="k">row</span> <span class="mi">20</span> <span class="k">and</span> <span class="n">perform</span> <span class="n">the</span> <span class="n">locking</span> <span class="k">to</span> <span class="n">prevent</span> <span class="n">multiple</span> <span class="n">entries</span>
</pre></table></code></div></div><hr /><h3 id="two-phase-locking"><span class="mr-2">Two-Phase Locking</span><a href="#two-phase-locking" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>One use case is a movie ticket booking system where for a Cinema, show and seat multiple booking problem can happen as at microsecond level this is difficult to handle for the database.</p><p>One solution is Two-phase locking.</p><p>In this at database level, it is about acquiring exclusive lock at row level for a row id.</p><p>Using below to acquire lock on a table:</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">seats</span> <span class="k">where</span> <span class="n">id</span><span class="o">=</span><span class="mi">15</span> <span class="k">for</span> <span class="k">update</span><span class="p">;</span>
</pre></table></code></div></div><p>Above command will acquire exclusive write lock. Now if other transactions attempt to acquire any lock it will be blocked until the first transaction rollbacks or commits which basically releases the lock.</p><p>So the above command for other transactions will return the updated data which was committed by the first transaction.</p><h4 id="spring-boot-example-with-jdbc-template"><span class="mr-2">Spring Boot Example with JDBC Template:</span><a href="#spring-boot-example-with-jdbc-template" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TicketBookingService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">bookSeat</span><span class="o">(</span><span class="nc">Long</span> <span class="n">seatId</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Phase 1: Acquire lock</span>
            <span class="nc">String</span> <span class="n">lockSql</span> <span class="o">=</span> <span class="s">"SELECT * FROM seats WHERE id = ? FOR UPDATE"</span><span class="o">;</span>
            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">lockSql</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">seatId</span><span class="o">},</span> <span class="o">(</span><span class="n">rs</span><span class="o">,</span> <span class="n">rowNum</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">rs</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
            <span class="o">});</span>

            <span class="c1">// Check if seat is available</span>
            <span class="nc">String</span> <span class="n">checkSql</span> <span class="o">=</span> <span class="s">"SELECT is_booked FROM seats WHERE id = ?"</span><span class="o">;</span>
            <span class="kt">boolean</span> <span class="n">isBooked</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">checkSql</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">seatId</span><span class="o">},</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">isBooked</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// Phase 2: Perform update</span>
                <span class="nc">String</span> <span class="n">updateSql</span> <span class="o">=</span> <span class="s">"UPDATE seats SET is_booked = true, user_id = ? WHERE id = ?"</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">updatedRows</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">updateSql</span><span class="o">,</span> <span class="n">userId</span><span class="o">,</span> <span class="n">seatId</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">updatedRows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Handle exceptions (e.g., deadlock)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>This example uses Spring’s JdbcTemplate to implement Two-Phase Locking:</p><ul><li><strong>Phase 1 (Acquiring the lock)</strong>: The “SELECT … FOR UPDATE” statement acquires an exclusive lock on the seat row.<li><strong>Phase 2 (Performing the update)</strong>: If the seat is available, the code updates it to mark it as booked.</ul><p>The <code class="language-plaintext highlighter-rouge">@Transactional</code> annotation ensures that the entire method runs within a single transaction, maintaining consistency.</p><blockquote><p><strong>Note</strong>: This is a simplified example. In a production environment, you’d need to handle more edge cases, implement proper error handling, and possibly use more sophisticated locking mechanisms depending on your specific requirements and database capabilities.</p></blockquote><h4 id="spring-data-jpa-implementation"><span class="mr-2">Spring Data JPA Implementation:</span><a href="#spring-data-jpa-implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.JpaRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.jpa.repository.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.repository.query.Param</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.LockModeType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SeatRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">Seat</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Lock</span><span class="o">(</span><span class="nc">LockModeType</span><span class="o">.</span><span class="na">PESSIMISTIC_WRITE</span><span class="o">)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"SELECT s FROM Seat s WHERE s.id = :id"</span><span class="o">)</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Seat</span><span class="o">&gt;</span> <span class="nf">findByIdAndLock</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TicketBookingService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SeatRepository</span> <span class="n">seatRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">bookSeat</span><span class="o">(</span><span class="nc">Long</span> <span class="n">seatId</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// Phase 1: Acquire lock</span>
            <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Seat</span><span class="o">&gt;</span> <span class="n">seatOptional</span> <span class="o">=</span> <span class="n">seatRepository</span><span class="o">.</span><span class="na">findByIdAndLock</span><span class="o">(</span><span class="n">seatId</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">seatOptional</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">Seat</span> <span class="n">seat</span> <span class="o">=</span> <span class="n">seatOptional</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

                <span class="c1">// Check if seat is available</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">seat</span><span class="o">.</span><span class="na">isBooked</span><span class="o">())</span> <span class="o">{</span>
                    <span class="c1">// Phase 2: Perform update</span>
                    <span class="n">seat</span><span class="o">.</span><span class="na">setBooked</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                    <span class="n">seat</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
                    <span class="n">seatRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">seat</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Handle exceptions (e.g., deadlock)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"seats"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Seat</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="nc">GenerationType</span><span class="o">.</span><span class="na">IDENTITY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"is_booked"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isBooked</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"user_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">userId</span><span class="o">;</span>

    <span class="c1">// Getters and setters</span>
<span class="o">}</span>
</pre></table></code></div></div><p>In this example:</p><ul><li>We define a custom query method <code class="language-plaintext highlighter-rouge">findByIdAndLock</code> in the <code class="language-plaintext highlighter-rouge">SeatRepository</code> interface. This method uses the <code class="language-plaintext highlighter-rouge">@Lock</code> annotation with <code class="language-plaintext highlighter-rouge">LockModeType.PESSIMISTIC_WRITE</code> to acquire an exclusive lock on the seat row.<li>The <code class="language-plaintext highlighter-rouge">TicketBookingService</code> uses this repository method to implement the Two-Phase Locking:<ul><li><strong>Phase 1</strong>: Acquiring the lock with <code class="language-plaintext highlighter-rouge">findByIdAndLock</code><li><strong>Phase 2</strong>: Performing the update if the seat is available</ul></ul><p>This approach leverages Spring Data JPA’s features to implement the locking mechanism, making the code more concise and easier to maintain compared to the JDBC Template version.</p><hr /><h3 id="two-phase-locking-alternative-approach"><span class="mr-2">Two-Phase Locking: Alternative Approach</span><a href="#two-phase-locking-alternative-approach" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The core idea is the same: the database will acquire an exclusive lock. Instead of checking whether the seat is booked, we will execute the update command with the condition that <code class="language-plaintext highlighter-rouge">is_booked</code> is false. The update command will internally acquire a row lock (internal lock, not user lock).</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">UPDATE</span> <span class="n">seats</span> <span class="k">SET</span> <span class="n">is_booked</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="s1">'Pravin'</span> <span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span><span class="mi">1</span> <span class="k">AND</span> <span class="n">is_booked</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></table></code></div></div><p>If transaction 1 executes the above command, it will fetch the record and see that the row is not locked, so it will acquire the lock as it can see the condition is met.</p><p>Now if transaction 2 also executes the above command, it will see the condition is met but the row is currently locked as this information is stored in heap at row level. So it will be blocked.</p><p>Now if transaction 1 commits, that data is saved in the heap/table. Transaction 2 ideally will get unblocked and update the data, but <strong>PostgreSQL does this differently</strong> - it will refresh the data as this is stored at row level for lock info. So now on refresh it will see the condition is failed and it will not update.</p><blockquote><p><strong>Important</strong>: This behavior is database-specific and we cannot guarantee similar behavior in different database systems.</p></blockquote><p>For the above approach to work, you need to be in read commit mode of isolation.</p><hr /><h3 id="sql-pagination-with-offset-is-very-slow"><span class="mr-2">SQL Pagination with Offset Is Very Slow</span><a href="#sql-pagination-with-offset-is-very-slow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><a href="/assets/document/attachment/database-engineering-fundamental-part-3//offset.mp4">offset.mp4</a></p><p>Using offset puts the database to do a lot of work. It will fetch all the records matching the condition and then apply offset and use limit to retrieve the selected rows.</p><p>This is fine for small datasets but for large datasets when in a single TCP connection we are requesting multiple pages, our DB is fetching the same rows again from the beginning and doing the same operation multiple times. Such a wastage!</p><p>Also, if some new records get added to the table, then the offset approach can give you duplicate records in the response.</p><p>Let’s take an example to understand:</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">EXPLAIN</span> <span class="k">ANALYZE</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">employees</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">DESC</span> <span class="k">OFFSET</span> <span class="mi">1000</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">31</span><span class="p">.</span><span class="mi">51</span><span class="p">..</span><span class="mi">31</span><span class="p">.</span><span class="mi">82</span> <span class="k">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="nb">time</span><span class="o">=</span><span class="mi">92</span><span class="p">.</span><span class="mi">830</span><span class="p">..</span><span class="mi">93</span><span class="p">.</span><span class="mi">295</span> <span class="k">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="o">-&gt;</span>  <span class="k">Index</span> <span class="n">Scan</span> <span class="k">Backward</span> <span class="k">using</span> <span class="n">employees_pkey</span> <span class="k">on</span> <span class="n">employees</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">..</span><span class="mi">31085</span><span class="p">.</span><span class="mi">44</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1000001</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="nb">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">040</span><span class="p">..</span><span class="mi">76</span><span class="p">.</span><span class="mi">360</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1010</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Planning</span> <span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">297</span> <span class="n">ms</span>
<span class="n">Execution</span> <span class="nb">Time</span><span class="p">:</span> <span class="mi">93</span><span class="p">.</span><span class="mi">534</span> <span class="n">ms</span>
</pre></table></code></div></div><p>You can see 1010 rows are fetched → 1000 due to offset and 10 due to limit. Let’s increase the offset:</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">EXPLAIN</span> <span class="k">ANALYZE</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">employees</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">DESC</span> <span class="k">OFFSET</span> <span class="mi">100000</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">3108</span><span class="p">.</span><span class="mi">92</span><span class="p">..</span><span class="mi">3109</span><span class="p">.</span><span class="mi">23</span> <span class="k">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="nb">time</span><span class="o">=</span><span class="mi">2940</span><span class="p">.</span><span class="mi">183</span><span class="p">..</span><span class="mi">2940</span><span class="p">.</span><span class="mi">972</span> <span class="k">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="o">-&gt;</span>  <span class="k">Index</span> <span class="n">Scan</span> <span class="k">Backward</span> <span class="k">using</span> <span class="n">employees_pkey</span> <span class="k">on</span> <span class="n">employees</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">..</span><span class="mi">31085</span><span class="p">.</span><span class="mi">44</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1000001</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="nb">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">030</span><span class="p">..</span><span class="mi">1721</span><span class="p">.</span><span class="mi">297</span> <span class="k">rows</span><span class="o">=</span><span class="mi">100010</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">Planning</span> <span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">086</span> <span class="n">ms</span>
<span class="n">Execution</span> <span class="nb">Time</span><span class="p">:</span> <span class="mi">2941</span><span class="p">.</span><span class="mi">167</span> <span class="n">ms</span>
</pre></table></code></div></div><p>OMG! You can see the number of rows retrieved is 100010 which causes the execution time to go around 100x times the previous query just to retrieve 10 rows. Obviously, the database will do the caching but that is not the solution.</p><h4 id="better-approach-using-id-for-pagination"><span class="mr-2">Better Approach: Using ID for Pagination</span><a href="#better-approach-using-id-for-pagination" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>A better approach would be to use the ID to tell the DB not to reach anything before that. If let’s say the last ID read by the database is 999992 then we can use it to retrieve from that onwards:</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span data-label-text="Sql"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">EXPLAIN</span> <span class="k">ANALYZE</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">employees</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">999992</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">id</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>

<span class="k">Limit</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">76</span> <span class="k">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="nb">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">054</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">521</span> <span class="k">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="o">-&gt;</span>  <span class="k">Index</span> <span class="n">Scan</span> <span class="k">Backward</span> <span class="k">using</span> <span class="n">employees_pkey</span> <span class="k">on</span> <span class="n">employees</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">..</span><span class="mi">33585</span><span class="p">.</span><span class="mi">25</span> <span class="k">rows</span><span class="o">=</span><span class="mi">999990</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="nb">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">023</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">183</span> <span class="k">rows</span><span class="o">=</span><span class="mi">10</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">999992</span><span class="p">)</span>
<span class="n">Planning</span> <span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">106</span> <span class="n">ms</span>
<span class="n">Execution</span> <span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">750</span> <span class="n">ms</span>
</pre></table></code></div></div><p>Data is already cached so it will be quite fast, but the above query is fast as we are using the index to decide from where to start the scan and it will eliminate the need to scan entire rows from offset 0.</p><p>Also, the number of rows retrieved is 10 so it is better for the DB as well since data read by the DB is less.</p><hr /><h3 id="database-connection-pooling"><span class="mr-2">Database Connection Pooling</span><a href="#database-connection-pooling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Database connection pooling is a technique used to manage and reuse database connections efficiently. In a production system, it offers several benefits:</p><ul><li><strong>Improved performance</strong>: Reusing existing connections reduces the overhead of creating new ones<li><strong>Better resource management</strong>: It limits the number of open connections, preventing database overload<li><strong>Reduced latency</strong>: Connections are readily available, minimizing wait times for database operations<li><strong>Enhanced scalability</strong>: It allows applications to handle more concurrent users with fewer resources</ul><p>Here’s an example of how to configure connection pooling in a Spring Boot application using HikariCP (the default connection pool):</p><div class="language-properties highlighter-rouge"><div class="code-header"> <span data-label-text="Properties"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c"># application.properties
</span>
<span class="c"># DataSource configuration
</span><span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:postgresql://localhost:5432/mydb</span>
<span class="py">spring.datasource.username</span><span class="p">=</span><span class="s">myuser</span>
<span class="py">spring.datasource.password</span><span class="p">=</span><span class="s">mypassword</span>

<span class="c"># HikariCP settings
</span><span class="py">spring.datasource.hikari.maximum-pool-size</span><span class="p">=</span><span class="s">10</span>
<span class="py">spring.datasource.hikari.minimum-idle</span><span class="p">=</span><span class="s">5</span>
<span class="py">spring.datasource.hikari.idle-timeout</span><span class="p">=</span><span class="s">600000</span>
<span class="py">spring.datasource.hikari.max-lifetime</span><span class="p">=</span><span class="s">1800000</span>
</pre></table></code></div></div><p>In this configuration:</p><ul><li><code class="language-plaintext highlighter-rouge">maximum-pool-size</code>: Sets the maximum number of connections in the pool<li><code class="language-plaintext highlighter-rouge">minimum-idle</code>: Sets the minimum number of idle connections to maintain in the pool<li><code class="language-plaintext highlighter-rouge">idle-timeout</code>: Specifies how long a connection can remain idle in the pool before being removed<li><code class="language-plaintext highlighter-rouge">max-lifetime</code>: Defines the maximum lifetime of a connection in the pool</ul><p>With this setup, Spring Boot will automatically use the connection pool for database operations. The benefits in a production system include:</p><ul><li><strong>Developers</strong>: Simplified code as connection management is handled automatically<li><strong>Operations team</strong>: Improved application stability and easier resource management<li><strong>End-users</strong>: Faster response times and better overall application performance<li><strong>Business</strong>: Increased system capacity and potential cost savings on infrastructure</ul><p>By efficiently managing database connections, connection pooling helps create more robust and scalable applications in production environments.</p><hr /><h2 id="replication"><span class="mr-2">Replication</span><a href="#replication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="masterbackup-replication"><span class="mr-2">Master/Backup Replication</span><a href="#masterbackup-replication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>One Master/Leader node that accepts writes/ddls<li>One or more backup/standby nodes that receive those writes from the master<li>Simple to implement no conflicts</ul><h3 id="multi-master-replication"><span class="mr-2">Multi-Master Replication</span><a href="#multi-master-replication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Multiple Master/Leader node that accepts writes/ddls<li>One or more backup/follower nodes that receive those writes from the masters<li>Need to resolves conflict</ul><h3 id="synchronous-vs-asynchronous-replication"><span class="mr-2">Synchronous vs Asynchronous Replication</span><a href="#synchronous-vs-asynchronous-replication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li>Synchronous Replication, A write transaction to the master will be blocked until it is written to the backup/standby nodes<li>First 2, First 1 or Any<li>Asynchronous Rep, A write transaction is considered successful if it written to the master, then asynchronously the writes are applied to backup nodes</ul><h3 id="pros--cons-of-replication"><span class="mr-2">Pros &amp; Cons of Replication</span><a href="#pros--cons-of-replication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><strong>Pros</strong></p><ul><li>Horizontal Scaling<li>Region based queries - DB per region</ul><p><strong>Cons</strong></p><ul><li>Eventual Consistency<li>Slow Writes (synchronous)<li>Complex to Implement (multi-master)</ul><h3 id="sql-vs-nosql-architecture"><span class="mr-2">SQL vs NoSQL Architecture</span><a href="#sql-vs-nosql-architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ul><li><a href="mongodb-internal-architecture"><strong>MongoDB internal Architecture</strong></a><li><a href="mongodb-collection-clustered-index"><strong>MongoDB collection clustered index</strong></a><li><a href="memcached-in-memory-database-architecture"><strong>MemCached In-Memory database Architecture</strong></a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/article/'>Article</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/softwareengineering/" class="post-tag no-text-decoration" >softwareengineering</a> <a href="/tags/backenddevelopment/" class="post-tag no-text-decoration" >backenddevelopment</a> <a href="/tags/database-engineering/" class="post-tag no-text-decoration" >database-engineering</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Part+3%3A+Database+Engineering+Fundamentals+-+Pravin+on+Software&url=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-3%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Part+3%3A+Database+Engineering+Fundamentals+-+Pravin+on+Software&u=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-3%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-3%2F&text=Part+3%3A+Database+Engineering+Fundamentals+-+Pravin+on+Software" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fpravin.dev%2Fdatabase-engineering-fundamental-part-3%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/database-engineering-fundamental-part-2/">Part 2: Database Engineering Fundamentals</a><li><a href="/posts/system-design-roadmap/">Comprehensive Roadmap for Low-Level and High-Level Design Interview Preparation</a><li><a href="/database-engineering-fundamental-part-5/write-amplification-problem-in-postgresql/">Part 5: Database Engineering Fundamentals: Write Amplification Problem in PostgreSQL</a><li><a href="/database-engineering-fundamental-part-1/">Part 1: Database Engineering Fundamentals</a><li><a href="/database-engineering-fundamental-part-1/database-page/">Part 1: Database Engineering Fundamentals: Database Page</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/backenddevelopment/">backenddevelopment</a> <a class="post-tag" href="/tags/softwareengineering/">softwareengineering</a> <a class="post-tag" href="/tags/database-engineering/">database-engineering</a> <a class="post-tag" href="/tags/design/">design</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/smells/">smells</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/nodejs/">nodejs</a> <a class="post-tag" href="/tags/softwaredevelopment/">softwaredevelopment</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/database-engineering-fundamental-part-5/write-amplification-problem-in-postgresql/"><div class="card-body"> <em class="small" data-ts="1720157400" data-df="ll" > Jul 5, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Part 5: Database Engineering Fundamentals: Write Amplification Problem in PostgreSQL</h3><div class="text-muted small"><p> Write Amplification Problem in PostgreSQL Write Amplification Problem in PostgreSQL The Write Amplification Problem (WAP) typically arises in systems using Solid State Drives (SSDs) or other stor...</p></div></div></a></div><div class="card"> <a href="/database-engineering-fundamental-part-1/"><div class="card-body"> <em class="small" data-ts="1719775800" data-df="ll" > Jul 1, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Part 1: Database Engineering Fundamentals</h3><div class="text-muted small"><p> Table of Contents ACID Properties Understanding Database Internals Row-Based vs Column-Based Databases Primary Key vs Secondary Key Database Indexing SQL Query Planner and Optimizer ...</p></div></div></a></div><div class="card"> <a href="/database-engineering-fundamental-part-1/database-page/"><div class="card-body"> <em class="small" data-ts="1719779400" data-df="ll" > Jul 1, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Part 1: Database Engineering Fundamentals: Database Page</h3><div class="text-muted small"><p> Databases Pages (Article) Database Pages — A deep dive Databases often use fixed-size pages to store data. Tables, collections, rows, columns, indexes, sequences, documents and more eventually en...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/database-engineering-fundamental-part-2/sharding-with-postgres/" class="btn btn-outline-primary" prompt="Older"><p>Part 2: Database Engineering Fundamentals: Sharding with Postgres</p></a> <a href="/database-engineering-fundamental-part-3/memcached-in-memory-database-architecture/" class="btn btn-outline-primary" prompt="Newer"><p>Part 3: Database Engineering Fundamentals: MemCached In-Memory database Architecture</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://pravin.dev/database-engineering-fundamental-part-3/'; this.page.identifier = '/database-engineering-fundamental-part-3/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://pravin-dev.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://www.linkedin.com/in/pravin-r-tripathi">Pravin Tripathi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/backenddevelopment/">backenddevelopment</a> <a class="post-tag" href="/tags/softwareengineering/">softwareengineering</a> <a class="post-tag" href="/tags/database-engineering/">database-engineering</a> <a class="post-tag" href="/tags/design/">design</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/smells/">smells</a> <a class="post-tag" href="/tags/java/">java</a> <a class="post-tag" href="/tags/nodejs/">nodejs</a> <a class="post-tag" href="/tags/softwaredevelopment/">softwaredevelopment</a> <a class="post-tag" href="/tags/aws/">aws</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-WP90FFJ6SJ"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-WP90FFJ6SJ'); }); </script>
